{"version":3,"sources":["HotUpdate.js"],"names":["cc","Class","extends","Component","properties","updatePanel","default","type","Node","manifestUrl","url","RawAsset","percent","Label","lblErr","checkCb","event","log","getEventCode","jsb","EventAssetsManager","ERROR_NO_LOCAL_MANIFEST","eventManager","removeListener","_checkListener","ERROR_DOWNLOAD_MANIFEST","ERROR_PARSE_MANIFEST","ALREADY_UP_TO_DATE","string","director","loadScene","NEW_VERSION_FOUND","_needUpdate","active","hotUpdate","updateCb","needRestart","failed","UPDATE_PROGRESSION","getPercent","percentByFile","getPercentByFile","msg","getMessage","toFixed","UPDATE_FINISHED","UPDATE_FAILED","_failCount","_am","downloadFailedAssets","ERROR_UPDATING","getAssetId","ERROR_DECOMPRESS","_updateListener","searchPaths","fileUtils","getSearchPaths","newPaths","getLocalManifest","Array","prototype","unshift","sys","localStorage","setItem","JSON","stringify","setSearchPaths","game","restart","EventListenerAssetsManager","bind","addListener","update","onLoad","isNative","storagePath","getWritablePath","AssetsManager","retain","isLoaded","checkUpdate","onDestroy","release"],"mappings":";;;;;;AAAAA,GAAGC,KAAH,CAAS;AACLC,aAASF,GAAGG,SADP;;AAGLC,gBAAY;AACRC,qBAAa;AACTC,qBAAS,IADA;AAETC,kBAAMP,GAAGQ;AAFA,SADL;AAKRC,qBAAa;AACTH,qBAAS,IADA;AAETI,iBAAKV,GAAGW;AAFC,SALL;AASRC,iBAAS;AACLN,qBAAS,IADJ;AAELC,kBAAMP,GAAGa;AAFJ,SATD;AAaRC,gBAAQ;AACJR,qBAAS,IADL;AAEJC,kBAAMP,GAAGa;AAFL;AAbA,KAHP;;AAsBLE,aAAS,iBAAUC,KAAV,EAAiB;AACtBhB,WAAGiB,GAAH,CAAO,WAAWD,MAAME,YAAN,EAAlB;AACA,gBAAQF,MAAME,YAAN,EAAR;AAEI,iBAAKC,IAAIC,kBAAJ,CAAuBC,uBAA5B;AACIrB,mBAAGiB,GAAH,CAAO,mDAAP;AACAjB,mBAAGsB,YAAH,CAAgBC,cAAhB,CAA+B,KAAKC,cAApC;AACA;AACJ,iBAAKL,IAAIC,kBAAJ,CAAuBK,uBAA5B;AACA,iBAAKN,IAAIC,kBAAJ,CAAuBM,oBAA5B;AACI1B,mBAAGiB,GAAH,CAAO,qDAAP;AACAjB,mBAAGsB,YAAH,CAAgBC,cAAhB,CAA+B,KAAKC,cAApC;AACA;AACJ,iBAAKL,IAAIC,kBAAJ,CAAuBO,kBAA5B;AACI3B,mBAAGiB,GAAH,CAAO,oDAAP;AACAjB,mBAAGsB,YAAH,CAAgBC,cAAhB,CAA+B,KAAKC,cAApC;AACA,qBAAKV,MAAL,CAAYc,MAAZ,IAAsB,WAAtB;AACA5B,mBAAG6B,QAAH,CAAYC,SAAZ,CAAsB,SAAtB;AACA;AACJ,iBAAKX,IAAIC,kBAAJ,CAAuBW,iBAA5B;AACI,qBAAKC,WAAL,GAAmB,IAAnB;AACA,qBAAK3B,WAAL,CAAiB4B,MAAjB,GAA0B,IAA1B;AACA,qBAAKrB,OAAL,CAAagB,MAAb,GAAsB,QAAtB;AACA5B,mBAAGsB,YAAH,CAAgBC,cAAhB,CAA+B,KAAKC,cAApC;AACA;AACJ;AACI;AAxBR;AA0BA,aAAKU,SAAL;AACH,KAnDI;;AAqDLC,cAAU,kBAAUnB,KAAV,EAAiB;AACvB,YAAIoB,cAAc,KAAlB;AACA,YAAIC,SAAS,KAAb;AACA,gBAAQrB,MAAME,YAAN,EAAR;AAEI,iBAAKC,IAAIC,kBAAJ,CAAuBC,uBAA5B;AACIrB,mBAAGiB,GAAH,CAAO,mDAAP;AACAoB,yBAAS,IAAT;AACA;AACJ,iBAAKlB,IAAIC,kBAAJ,CAAuBkB,kBAA5B;AACI,oBAAI1B,UAAUI,MAAMuB,UAAN,EAAd;AACA,oBAAIC,gBAAgBxB,MAAMyB,gBAAN,EAApB;;AAEA,oBAAIC,MAAM1B,MAAM2B,UAAN,EAAV;AACA,oBAAID,GAAJ,EAAS;AACL1C,uBAAGiB,GAAH,CAAOyB,GAAP;AACH;AACD1C,mBAAGiB,GAAH,CAAOL,QAAQgC,OAAR,CAAgB,CAAhB,IAAqB,GAA5B;AACA,qBAAKhC,OAAL,CAAagB,MAAb,GAAsBhB,UAAU,GAAhC;AACA;AACJ,iBAAKO,IAAIC,kBAAJ,CAAuBK,uBAA5B;AACA,iBAAKN,IAAIC,kBAAJ,CAAuBM,oBAA5B;AACI1B,mBAAGiB,GAAH,CAAO,qDAAP;AACAoB,yBAAS,IAAT;AACA;AACJ,iBAAKlB,IAAIC,kBAAJ,CAAuBO,kBAA5B;AACI3B,mBAAGiB,GAAH,CAAO,oDAAP;AACAoB,yBAAS,IAAT;AACA;AACJ,iBAAKlB,IAAIC,kBAAJ,CAAuByB,eAA5B;AACI7C,mBAAGiB,GAAH,CAAO,sBAAsBD,MAAM2B,UAAN,EAA7B;;AAEAP,8BAAc,IAAd;AACA;AACJ,iBAAKjB,IAAIC,kBAAJ,CAAuB0B,aAA5B;AACI9C,mBAAGiB,GAAH,CAAO,oBAAoBD,MAAM2B,UAAN,EAA3B;;AAEA,qBAAKI,UAAL;AACA,oBAAI,KAAKA,UAAL,GAAkB,CAAtB,EACA;AACI,yBAAKC,GAAL,CAASC,oBAAT;AACH,iBAHD,MAKA;AACIjD,uBAAGiB,GAAH,CAAO,+CAAP;AACA,yBAAK8B,UAAL,GAAkB,CAAlB;AACAV,6BAAS,IAAT;AACH;AACD;AACJ,iBAAKlB,IAAIC,kBAAJ,CAAuB8B,cAA5B;AACIlD,mBAAGiB,GAAH,CAAO,yBAAyBD,MAAMmC,UAAN,EAAzB,GAA8C,IAA9C,GAAqDnC,MAAM2B,UAAN,EAA5D;AACA;AACJ,iBAAKxB,IAAIC,kBAAJ,CAAuBgC,gBAA5B;AACIpD,mBAAGiB,GAAH,CAAOD,MAAM2B,UAAN,EAAP;AACA;AACJ;AACI;AArDR;;AAwDA,YAAIN,MAAJ,EAAY;AACRrC,eAAGsB,YAAH,CAAgBC,cAAhB,CAA+B,KAAK8B,eAApC;AACA,iBAAKhD,WAAL,CAAiB4B,MAAjB,GAA0B,KAA1B;AACH;;AAED,YAAIG,WAAJ,EAAiB;AACbpC,eAAGsB,YAAH,CAAgBC,cAAhB,CAA+B,KAAK8B,eAApC;AACA;AACA,gBAAIC,cAAcnC,IAAIoC,SAAJ,CAAcC,cAAd,EAAlB;AACA,gBAAIC,WAAW,KAAKT,GAAL,CAASU,gBAAT,GAA4BF,cAA5B,EAAf;AACAG,kBAAMC,SAAN,CAAgBC,OAAhB,CAAwBP,WAAxB,EAAqCG,QAArC;AACA;AACA;AACA;AACAzD,eAAG8D,GAAH,CAAOC,YAAP,CAAoBC,OAApB,CAA4B,sBAA5B,EAAoDC,KAAKC,SAAL,CAAeZ,WAAf,CAApD;;AAEAnC,gBAAIoC,SAAJ,CAAcY,cAAd,CAA6Bb,WAA7B;AACA,iBAAKxC,MAAL,CAAYc,MAAZ,IAAsB,YAAtB;AACA5B,eAAGoE,IAAH,CAAQC,OAAR;AACH;AACJ,KApII;;AAsILnC,eAAW,qBAAY;AACnB,YAAI,KAAKc,GAAL,IAAY,KAAKhB,WAArB,EAAkC;AAC9B,iBAAKlB,MAAL,CAAYc,MAAZ,IAAsB,eAAtB;AACA,iBAAKyB,eAAL,GAAuB,IAAIlC,IAAImD,0BAAR,CAAmC,KAAKtB,GAAxC,EAA6C,KAAKb,QAAL,CAAcoC,IAAd,CAAmB,IAAnB,CAA7C,CAAvB;AACAvE,eAAGsB,YAAH,CAAgBkD,WAAhB,CAA4B,KAAKnB,eAAjC,EAAkD,CAAlD;;AAEA,iBAAKN,UAAL,GAAkB,CAAlB;AACA,iBAAKC,GAAL,CAASyB,MAAT;AACH;AACJ,KA/II;;AAiJL;AACAC,YAAQ,kBAAY;AAChB;AACA,YAAI,CAAC1E,GAAG8D,GAAH,CAAOa,QAAZ,EAAsB;AAClB;AACH;AACD,aAAK7D,MAAL,CAAYc,MAAZ,IAAsB,aAAtB;AACA,YAAIgD,cAAe,CAACzD,IAAIoC,SAAJ,GAAgBpC,IAAIoC,SAAJ,CAAcsB,eAAd,EAAhB,GAAkD,GAAnD,IAA0D,qBAA7E;AACA7E,WAAGiB,GAAH,CAAO,qCAAqC2D,WAA5C;AACA,aAAK9D,MAAL,CAAYc,MAAZ,IAAsBgD,cAAc,IAApC;AACA5E,WAAGiB,GAAH,CAAO,0BAA0B,KAAKR,WAAtC;AACA,aAAKuC,GAAL,GAAW,IAAI7B,IAAI2D,aAAR,CAAsB,KAAKrE,WAA3B,EAAwCmE,WAAxC,CAAX;AACA,aAAK5B,GAAL,CAAS+B,MAAT;;AAEA,aAAK/C,WAAL,GAAmB,KAAnB;AACA,YAAI,KAAKgB,GAAL,CAASU,gBAAT,GAA4BsB,QAA5B,EAAJ,EACA;AACI,iBAAKxD,cAAL,GAAsB,IAAIL,IAAImD,0BAAR,CAAmC,KAAKtB,GAAxC,EAA6C,KAAKjC,OAAL,CAAawD,IAAb,CAAkB,IAAlB,CAA7C,CAAtB;AACAvE,eAAGsB,YAAH,CAAgBkD,WAAhB,CAA4B,KAAKhD,cAAjC,EAAiD,CAAjD;;AAEA,iBAAKwB,GAAL,CAASiC,WAAT;AACH;AACJ,KAvKI;;AAyKLC,eAAW,qBAAY;AACnB,aAAKlC,GAAL,IAAY,KAAKA,GAAL,CAASmC,OAAT,EAAZ;AACH;AA3KI,CAAT","file":"HotUpdate.js","sourceRoot":"..\\..\\..\\..\\assets\\scripts","sourcesContent":["cc.Class({\n    extends: cc.Component,\n\n    properties: {\n        updatePanel: {\n            default: null,\n            type: cc.Node\n        },\n        manifestUrl: {\n            default: null,\n            url: cc.RawAsset\n        },\n        percent: {\n            default: null,\n            type: cc.Label\n        },\n        lblErr: {\n            default: null,\n            type: cc.Label\n        }\n    },\n\n    checkCb: function (event) {\n        cc.log('Code: ' + event.getEventCode());\n        switch (event.getEventCode())\n        {\n            case jsb.EventAssetsManager.ERROR_NO_LOCAL_MANIFEST:\n                cc.log(\"No local manifest file found, hot update skipped.\");\n                cc.eventManager.removeListener(this._checkListener);\n                break;\n            case jsb.EventAssetsManager.ERROR_DOWNLOAD_MANIFEST:\n            case jsb.EventAssetsManager.ERROR_PARSE_MANIFEST:\n                cc.log(\"Fail to download manifest file, hot update skipped.\");\n                cc.eventManager.removeListener(this._checkListener);\n                break;\n            case jsb.EventAssetsManager.ALREADY_UP_TO_DATE:\n                cc.log(\"Already up to date with the latest remote version.\");\n                cc.eventManager.removeListener(this._checkListener);\n                this.lblErr.string += \"游戏不需要更新\\n\";\n                cc.director.loadScene(\"loading\");\n                break;\n            case jsb.EventAssetsManager.NEW_VERSION_FOUND:\n                this._needUpdate = true;\n                this.updatePanel.active = true;\n                this.percent.string = '00.00%';\n                cc.eventManager.removeListener(this._checkListener);\n                break;\n            default:\n                break;\n        }\n        this.hotUpdate();\n    },\n\n    updateCb: function (event) {\n        var needRestart = false;\n        var failed = false;\n        switch (event.getEventCode())\n        {\n            case jsb.EventAssetsManager.ERROR_NO_LOCAL_MANIFEST:\n                cc.log('No local manifest file found, hot update skipped.');\n                failed = true;\n                break;\n            case jsb.EventAssetsManager.UPDATE_PROGRESSION:\n                var percent = event.getPercent();\n                var percentByFile = event.getPercentByFile();\n\n                var msg = event.getMessage();\n                if (msg) {\n                    cc.log(msg);\n                }\n                cc.log(percent.toFixed(2) + '%');\n                this.percent.string = percent + '%';\n                break;\n            case jsb.EventAssetsManager.ERROR_DOWNLOAD_MANIFEST:\n            case jsb.EventAssetsManager.ERROR_PARSE_MANIFEST:\n                cc.log('Fail to download manifest file, hot update skipped.');\n                failed = true;\n                break;\n            case jsb.EventAssetsManager.ALREADY_UP_TO_DATE:\n                cc.log('Already up to date with the latest remote version.');\n                failed = true;\n                break;\n            case jsb.EventAssetsManager.UPDATE_FINISHED:\n                cc.log('Update finished. ' + event.getMessage());\n\n                needRestart = true;\n                break;\n            case jsb.EventAssetsManager.UPDATE_FAILED:\n                cc.log('Update failed. ' + event.getMessage());\n\n                this._failCount ++;\n                if (this._failCount < 5)\n                {\n                    this._am.downloadFailedAssets();\n                }\n                else\n                {\n                    cc.log('Reach maximum fail count, exit update process');\n                    this._failCount = 0;\n                    failed = true;\n                }\n                break;\n            case jsb.EventAssetsManager.ERROR_UPDATING:\n                cc.log('Asset update error: ' + event.getAssetId() + ', ' + event.getMessage());\n                break;\n            case jsb.EventAssetsManager.ERROR_DECOMPRESS:\n                cc.log(event.getMessage());\n                break;\n            default:\n                break;\n        }\n\n        if (failed) {\n            cc.eventManager.removeListener(this._updateListener);\n            this.updatePanel.active = false;\n        }\n\n        if (needRestart) {\n            cc.eventManager.removeListener(this._updateListener);\n            // Prepend the manifest's search path\n            var searchPaths = jsb.fileUtils.getSearchPaths();\n            var newPaths = this._am.getLocalManifest().getSearchPaths();\n            Array.prototype.unshift(searchPaths, newPaths);\n            // This value will be retrieved and appended to the default search path during game startup,\n            // please refer to samples/js-tests/main.js for detailed usage.\n            // !!! Re-add the search paths in main.js is very important, otherwise, new scripts won't take effect.\n            cc.sys.localStorage.setItem('HotUpdateSearchPaths', JSON.stringify(searchPaths));\n\n            jsb.fileUtils.setSearchPaths(searchPaths);\n            this.lblErr.string += \"游戏资源更新完毕\\n\";\n            cc.game.restart();\n        }\n    },\n\n    hotUpdate: function () {\n        if (this._am && this._needUpdate) {\n            this.lblErr.string += \"开始更新游戏资源...\\n\";\n            this._updateListener = new jsb.EventListenerAssetsManager(this._am, this.updateCb.bind(this));\n            cc.eventManager.addListener(this._updateListener, 1);\n\n            this._failCount = 0;\n            this._am.update();\n        }\n    },\n\n    // use this for initialization\n    onLoad: function () {\n        // Hot update is only available in Native build\n        if (!cc.sys.isNative) {\n            return;\n        }\n        this.lblErr.string += \"检查游戏资源...\\n\";\n        var storagePath = ((jsb.fileUtils ? jsb.fileUtils.getWritablePath() : '/') + 'tiantianqipai-asset');\n        cc.log('Storage path for remote asset : ' + storagePath);\n        this.lblErr.string += storagePath + \"\\n\";\n        cc.log('Local manifest URL : ' + this.manifestUrl);\n        this._am = new jsb.AssetsManager(this.manifestUrl, storagePath);\n        this._am.retain();\n\n        this._needUpdate = false;\n        if (this._am.getLocalManifest().isLoaded())\n        {\n            this._checkListener = new jsb.EventListenerAssetsManager(this._am, this.checkCb.bind(this));\n            cc.eventManager.addListener(this._checkListener, 1);\n\n            this._am.checkUpdate();\n        }\n    },\n\n    onDestroy: function () {\n        this._am && this._am.release();\n    }\n});\n"]}