{"version":3,"sources":["VoiceMgr.js"],"names":["radix","base","crypto","value","h","Math","floor","l","String","fromCharCode","encodermap","decodermap","i","code","v","encode","data","content","len","length","a","b","c","d","getCode","index","charCodeAt","charAt","decode","newData","Uint8Array","cnt","cc","Class","extends","Component","properties","onPlayCallback","_voiceMediaPath","init","prepare","filename","release","cancel","writeVoice","voiceData","clearCache","play","stop","getVoiceLevel","maxLevel","getVoiceData","download","setStorageDir","dir"],"mappings":"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A;AACA;AACA;AACA;AACA;AACH,KAxFI;;AA0FLC,gBAAW,oBAASH,QAAT,EAAkBI,SAAlB,EAA4B;AACnC;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACH,KArGI;;AAuGLC,gBAAW,oBAASL,QAAT,EAAkB;AACzB;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACH,KArHI;;AAuHLM,UAAK,cAASN,QAAT,EAAkB;AACnB;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACH,KArII;;AAuILO,UAAK,gBAAU;AACX;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACH,KApJI;;AAsJLC,mBAAc,uBAASC,QAAT,EAAkB;AAC5B;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACH,KAhKI;;AAkKLC,kBAAa,sBAASV,QAAT,EAAkB;AAC3B;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACH,KA7KI;;AA+KLW,cAAS,oBAAU,CAElB,CAjLI;AAkLL;AACA;;AAEA;;AAEAC,mBAAc,uBAASC,GAAT,EAAa;AAC3B;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACE;AApMG,CAAT","file":"VoiceMgr.js","sourceRoot":"..\\..\\..\\..\\assets\\scripts","sourcesContent":["var radix = 12;\r\nvar base = 128 - radix;\r\nfunction crypto(value){\r\n    value -= base;\r\n    var h = Math.floor(value/radix) + base;\r\n    var l = value%radix + base;\r\n    return String.fromCharCode(h) + String.fromCharCode(l);\r\n}\r\n\r\nvar encodermap = {}\r\nvar decodermap = {}\r\nfor(var i = 0; i < 256; ++i){\r\n    var code = null;\r\n    var v = i + 1;\r\n    if(v >= base){\r\n        code = crypto(v);\r\n    }\r\n    else{\r\n        code = String.fromCharCode(v);    \r\n    }\r\n    \r\n    encodermap[i] = code;\r\n    decodermap[code] = i;\r\n}\r\n\r\nfunction encode(data){\r\n    var content = \"\";\r\n    var len = data.length;\r\n    var a = (len >> 24) & 0xff;\r\n    var b = (len >> 16) & 0xff;\r\n    var c = (len >> 8) & 0xff;\r\n    var d = len & 0xff;\r\n    content += encodermap[a];\r\n    content += encodermap[b];\r\n    content += encodermap[c];\r\n    content += encodermap[d];\r\n    for(var i = 0; i < data.length; ++i){\r\n        content += encodermap[data[i]];\r\n    }\r\n    return content;\r\n}\r\n\r\nfunction getCode(content,index){\r\n    var c = content.charCodeAt(index);\r\n    if(c >= base){\r\n        c = content.charAt(index) + content.charAt(index + 1);\r\n    }\r\n    else{\r\n        c = content.charAt(index);\r\n    }\r\n    return c;\r\n}\r\nfunction decode(content){\r\n    var index = 0;\r\n    var len = 0;\r\n    for(var i = 0; i < 4; ++i){\r\n        var c = getCode(content,index);\r\n        index += c.length;\r\n        var v = decodermap[c];\r\n        len |= v << (3-i)*8;\r\n    }\r\n    \r\n    var newData = new Uint8Array(len);\r\n    var cnt = 0;\r\n    while(index < content.length){\r\n        var c = getCode(content,index);\r\n        index += c.length;\r\n        newData[cnt] = decodermap[c];\r\n        cnt++;\r\n    }\r\n    return newData;\r\n}\r\n\r\ncc.Class({\r\n    extends: cc.Component,\r\n\r\n    properties: {\r\n        // foo: {\r\n        //    default: null,      // The default value will be used only when the component attaching\r\n        //                           to a node for the first time\r\n        //    url: cc.Texture2D,  // optional, default is typeof default\r\n        //    serializable: true, // optional, default is true\r\n        //    visible: true,      // optional, default is true\r\n        //    displayName: 'Foo', // optional\r\n        //    readonly: false,    // optional, default is false\r\n        // },\r\n        // ...\r\n        onPlayCallback:null,\r\n        _voiceMediaPath:null,\r\n    },\r\n\r\n    // use this for initialization\r\n    init: function () {\r\n        /*\r\n        var url = cc.url.raw(\"resources/test.amr\");\r\n        var fileData = jsb.fileUtils.getDataFromFile(url);\r\n        var content = \"\";\r\n        var sep = \"\";\r\n        for(var i = 0; i < fileData.length; ++i){\r\n            content += sep + fileData[i];\r\n            sep = \",\";\r\n        }\r\n        \r\n        var url = cc.url.raw(\"resources/test.txt\");\r\n        jsb.fileUtils.writeStringToFile(content,url);\r\n        \r\n        var url = cc.url.raw(\"resources/test2.amrs\");\r\n        var content = encode(fileData);\r\n        jsb.fileUtils.writeStringToFile(content,url);\r\n        \r\n        var url = cc.url.raw(\"resources/test2.amr\");\r\n        jsb.fileUtils.writeDataToFile(decode(content),url);\r\n        */\r\n        \r\n        // if(cc.sys.isNative){\r\n        //     this._voiceMediaPath = jsb.fileUtils.getWritablePath() + \"/voicemsgs/\";\r\n        //     this.setStorageDir(this._voiceMediaPath);\r\n        // }\r\n    },\r\n    \r\n    prepare:function(filename){\r\n        //注释调对原声方法的调用\r\n        // if(!cc.sys.isNative){\r\n        //     return;\r\n        // }\r\n        // cc.vv.audioMgr.pauseAll();\r\n        // this.clearCache(filename);\r\n        // if(cc.sys.os == cc.sys.OS_ANDROID){\r\n        //     jsb.reflection.callStaticMethod(\"com/vivigames/voicesdk/VoiceRecorder\", \"prepare\", \"(Ljava/lang/String;)V\",filename);\r\n        // }\r\n        // else if(cc.sys.os == cc.sys.OS_IOS){\r\n        //     jsb.reflection.callStaticMethod(\"VoiceSDK\", \"prepareRecord:\",filename);\r\n        // }\r\n    },\r\n    \r\n    release:function(){\r\n        //注释调对原声方法的调用\r\n        // if(!cc.sys.isNative){\r\n        //     return;\r\n        // }\r\n        // cc.vv.audioMgr.resumeAll();\r\n        // if(cc.sys.os == cc.sys.OS_ANDROID){\r\n        //     jsb.reflection.callStaticMethod(\"com/vivigames/voicesdk/VoiceRecorder\", \"release\", \"()V\");\r\n        // }\r\n        // else if(cc.sys.os == cc.sys.OS_IOS){\r\n        //     jsb.reflection.callStaticMethod(\"VoiceSDK\", \"finishRecord\");\r\n        // }\r\n    },\r\n    \r\n    cancel:function(){\r\n        //注释调对原声方法的调用\r\n        // if(!cc.sys.isNative){\r\n        //     return;\r\n        // }\r\n        // cc.vv.audioMgr.resumeAll();\r\n        // if(cc.sys.os == cc.sys.OS_ANDROID){\r\n        //     jsb.reflection.callStaticMethod(\"com/vivigames/voicesdk/VoiceRecorder\", \"cancel\", \"()V\");\r\n        // }\r\n        // else if(cc.sys.os == cc.sys.OS_IOS){\r\n        //     jsb.reflection.callStaticMethod(\"VoiceSDK\", \"cancelRecord\");\r\n        // }\r\n    },\r\n\r\n    writeVoice:function(filename,voiceData){\r\n        //注释调对原声方法的调用\r\n        // if(!cc.sys.isNative){\r\n        //     return;\r\n        // }\r\n        // if(voiceData && voiceData.length > 0){\r\n        //     var fileData = decode(voiceData);\r\n        //     var url = this._voiceMediaPath + filename;\r\n        //     this.clearCache(filename);\r\n        //     jsb.fileUtils.writeDataToFile(fileData,url); \r\n        // }\r\n    },\r\n    \r\n    clearCache:function(filename){\r\n        //注释调对原声方法的调用\r\n        // if(cc.sys.isNative){\r\n        //     var url = this._voiceMediaPath + filename;\r\n        //     //console.log(\"check file:\" + url);\r\n        //     if(jsb.fileUtils.isFileExist(url)){\r\n        //         //console.log(\"remove:\" + url);\r\n        //         jsb.fileUtils.removeFile(url);\r\n        //     }\r\n        //     if(jsb.fileUtils.isFileExist(url + \".wav\")){\r\n        //         //console.log(\"remove:\" + url + \".wav\");\r\n        //         jsb.fileUtils.removeFile(url + \".wav\");\r\n        //     }   \r\n        // }\r\n    },\r\n    \r\n    play:function(filename){\r\n        //注释调对原声方法的调用\r\n        // if(!cc.sys.isNative){\r\n        //     return;\r\n        // }\r\n        // cc.vv.audioMgr.pauseAll();\r\n        // if(cc.sys.os == cc.sys.OS_ANDROID){\r\n        //     jsb.reflection.callStaticMethod(\"com/vivigames/voicesdk/VoicePlayer\", \"play\", \"(Ljava/lang/String;)V\",filename); \r\n        // }\r\n        // else if(cc.sys.os == cc.sys.OS_IOS){\r\n        //     jsb.reflection.callStaticMethod(\"VoiceSDK\", \"play:\",filename);\r\n        // }\r\n        // else{\r\n        // }\r\n    },\r\n    \r\n    stop:function(){\r\n        // if(!cc.sys.isNative){\r\n        //     return;\r\n        // }\r\n        // cc.vv.audioMgr.resumeAll();\r\n        // if(cc.sys.os == cc.sys.OS_ANDROID){\r\n        //     jsb.reflection.callStaticMethod(\"com/vivigames/voicesdk/VoicePlayer\", \"stop\", \"()V\"); \r\n        // }\r\n        // else if(cc.sys.os == cc.sys.OS_IOS){\r\n        //     jsb.reflection.callStaticMethod(\"VoiceSDK\", \"stopPlay\");\r\n        // }\r\n        // else{\r\n        // }\r\n    },\r\n    \r\n    getVoiceLevel:function(maxLevel){\r\n        // return Math.floor(Math.random() * maxLevel + 1);\r\n        // if(cc.sys.os == cc.sys.OS_ANDROID){ \r\n        //     return jsb.reflection.callStaticMethod(\"com/vivigames/voicesdk/VoiceRecorder\", \"getVoiceLevel\", \"(I)I\",maxLevel);\r\n        // }\r\n        // else if(cc.sys.os == cc.sys.OS_IOS){\r\n        // }\r\n        // else{\r\n        //     return Math.floor(Math.random() * maxLevel + 1);\r\n        // }\r\n    },\r\n    \r\n    getVoiceData:function(filename){\r\n        // if(cc.sys.isNative){\r\n        //     var url = this._voiceMediaPath + filename;\r\n        //     console.log(\"getVoiceData:\" + url);\r\n        //     var fileData = jsb.fileUtils.getDataFromFile(url);\r\n        //     if(fileData){\r\n        //         var content = encode(fileData);\r\n        //         return content;\r\n        //     }\r\n        // }\r\n        // return \"\";\r\n    },\r\n    \r\n    download:function(){\r\n        \r\n    },\r\n    // called every frame, uncomment this function to activate update callback\r\n    // update: function (dt) {\r\n\r\n    // },\r\n    \r\n    setStorageDir:function(dir){\r\n    //     if(!cc.sys.isNative){\r\n    //         return;\r\n    //     }\r\n    //     if(cc.sys.os == cc.sys.OS_ANDROID){ \r\n    //         jsb.reflection.callStaticMethod(\"com/vivigames/voicesdk/VoiceRecorder\", \"setStorageDir\", \"(Ljava/lang/String;)V\",dir);    \r\n    //     }\r\n    //     else if(cc.sys.os == cc.sys.OS_IOS){\r\n    //         jsb.reflection.callStaticMethod(\"VoiceSDK\", \"setStorageDir:\",dir);\r\n    //         if(!jsb.fileUtils.isDirectoryExist(dir)){\r\n    //             jsb.fileUtils.createDirectory(dir);\r\n    //         }\r\n    //     }\r\n     }\r\n});\r\n"]}